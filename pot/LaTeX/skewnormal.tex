\documentclass[11pt]{article}
\usepackage{amssymb, amsthm, amsmath}
\usepackage{bm}
\usepackage{graphicx}
\usepackage[authoryear]{natbib}
\usepackage{bm}
\usepackage{verbatim}
\usepackage{lineno}
\usepackage{times}
\usepackage{soul}
\usepackage{color}

\usepackage[left=1in,top=1in,right=1in]{geometry}
\pdfpageheight 11in
\pdfpagewidth 8.5in
\linespread{1.0}
\input{mycommands.sty}


\begin{document}\linenumbers

\begin{center}
{\Large {\bf A new spatial model for points above a threshold}}\\
\today
\end{center}

\section{Introduction}\label{s:intro}
In most climatological applications, researchers are interested in learning about the average behavior of different climate variables (e.g. ozone, temperature, rainfall).
However, averages do not help regulators prepare for the unusual events that only happen once every 100 years.
For example, it is important to have an idea of how much rain will come in a 100-year floor in order to construct strong enough river levees to protect lands from flooding.

Unlike multivariate normal distributions, it is challenging to model multivariate extreme value distributions (e.g. generalized extreme value and generalized Pareto distribution) because few closed-form expressions exist for the density in more than two-dimensions \citep{Coles1991}.
Given this limitation, pairwise composite likelihoods have been used when modeling dependent extremes \citep{Padoan2010,Blanchet2011,Huser2013}.

One way around the multi-dimensional limitation of multivariate extreme value distributions is to use skew elliptical distributions to model dependent extreme values \citep{Genton2004,Zhang2010,Padoan2011}.
Due to their flexibility, the skew-normal and skew-$t$ distribution offer a flexible way to handle non-symmetric data within a framework of multivariate normal and multivariate t-distributions.
As with the spatial Gaussian process, the skew-normal distribution is also asymptotically independent; however, the skew-$t$ does demonstrate asymptotic dependence \citep{Padoan2011}.
Although asymptotic dependence is desirable between sites that are near one another, one drawback to the skew-$t$ is that sites remain asymptotically dependent even at far distances.

In this paper, we present a model that has marginal distributions with flexible tails, demonstrates asymptotic dependence for small $\bh$, and has computation on the order of Gaussian models for large space-time datasets.
Specifically, our contribution is to incorporate thresholding and random spatial partitions using a multivariate skew-$t$ distribution.
The advantage of using a thresholded model as opposed to a non-thresholded model is that is allows for the tails of the distribution to inform the predictions in the tails \citep{DuMouchel1983}.
The random spatial partition alleviates the long-range spatial dependence seen by the skew-$t$.

\section{Statistical model}\label{s:model}
Let $Y_t(\bs)\in \calR$ be the observed value at location $\bs$ and timepoint $t$.
To avoid bias in estimating tail parameters, we model censored data
\beq\label{Yt}
  \Yt_t(\bs) = \left\{
          \begin{array}{ll}
            Y_t(\bs) & Y_t(\bs)>T \\
            T & Y_t(\bs)\le T
          \end{array}
        \right.
\eeq
where $T$ is a pre-specified threshold.
Then, assuming the full data follow a skew-$t$ distribution, we update values censored below the threshold using standard Bayesian missing data methods as described in Section \ref{s:comp}.

\subsection{Skew-$t$ process}\label{s:data}
We assume the data can be modeled as skew-$t$.
\citet{Zhang2010} show that the skew-$t$ can be written as the hierarchical model
\begin{align} \label{eq:fullmodel}
  Y_t(\bs) &= X_t(\bs) \beta + \alpha z_t + \sigma_t v_t(\bs)
\end{align}
where $\alpha \in \calR$ controls the skewness, $z_{t} \ind N_{(0, \infty)}(0, \sigma^2_t)$ are a random effect from a half-normal distribution (see appendix A.3), $v_t(\bs)$ is a Gaussian process with mean zero, variance one, and \Matern correlation, and $\sigma^2_t \iid \text{IG}(a, b)$.
When marginalizing over the $z_t$ and $\sigma^2_t$ terms,
\begin{align*}
  Y_t(\bs) \sim \text{skew-}t (\mu, \Sigma^*, \alpha, \text{df} = 2a)
\end{align*}
where $\mu$ is the location, $\Sigma^* = \frac{ b }{ a } \Sigma$, $\Sigma$ is a \Matern covariance matrix, and $\alpha \in \calR$ controls the skewness.
The skew-$t$ process is desirable because of its flexible tail, controlled by both the skewness parameter $\alpha$ and the degrees of freedom $2a$, and its joint distribution is a multivariate skew-$t$ distribution.

\subsection{Extremal dependence}
One common measure of extremal spatial dependence is the extremal coefficient which describes the pairwise dependence between spatial locations \citep{Smith1990}.
Consider a spatial process $Y(\bs) \in \calR^n$ observed at locations $s \in \calD \subset \calR^2$.
Then the bivariate extremal coefficient, $\theta(\bs_i, \bs_j) \in [1, 2]$, is defined as
\begin{align}
  \Pr(Y(\bs_i) < c, Y(\bs_j) < c) = \Pr(Y(\bs_i) < c)^{\theta(\bs_i, \bs_j) }. \label{eq:extremalcoef}
\end{align}
One way to characterize the dependence over the entire set of spatial locations is to calculate all of the pairwise extremal coefficients.
Although this method provides information regarding the spatial structure of the observations, it does not fully characterize the joint spatial dependence.

Another popular measure of extremal dependence is the $\chi$ statistic.
The $\chi$ coefficient for the upper tail is given by
\begin{align*}
  \chi = \lim_{c \rightarrow \infty} \Pr(Y(\bs_1) > c | Y(\bs_2) > c)
\end{align*}
In a stationary spatial process, we can write the $\chi$ coefficient as
\begin{align*}
  \chi(\bh) = \lim_{c \rightarrow \infty} \Pr(Y(0) > c | Y(\bh) > c)
\end{align*}
where $\bh = ||\bs_1 - \bs_2||$.
If $\chi(\bh) = 0$, then observations are asymptotically independent at distance $\bh$.
For Gaussian processes, $\chi(\bh) = 0$ regardless of the the distance, so they are not suitable for modeling spatially dependent extremes.
However, for the process described in Section \ref{s:data}, $\chi(\bh) > 0$ \citep{Padoan2011}.

\subsection{Random daily partition}\label{s:part}
One problem with the skew-$t$ distribution is that all sites are asymptotically dependent regardless of their spatial separation.
This occurs because all observations, both near and far, share the same $z_t$ and $\sigma^2_t$ terms.
We handle this problem with a daily random partition similar to \citet{Huser2014} that allows $z_t$ and $\sigma^2_t$ to vary by site.
The model then becomes
\begin{align}
  Y_t(\bs) &= X_t(\bs) \beta + \alpha z_t(\bs) + \sigma_t(\bs) v_t(\bs).
\end{align}
In this extension of (\ref{eq:fullmodel}), $z_t(\bs)$ and $\sigma_t(\bs)$ are allowed to vary by site.
Their spatial variation is determined by the random partition model defined below.
Consider a set of daily spatial knots $\bw_{tk} \sim \text{Uniform}(\calD)$ that define a random daily partition $P_{t1}, \ldots, P_{tK}$ of the spatial domain of interest $\calD \subset \calR^2$ such that
\begin{align*}
  P_{tk} = \{ \bs : k = \argmin_\ell || \bs - \bw_{t\ell} \}.
\end{align*}
So, for $\bs \in P_{tk}$, let
\begin{align}
  z_t(\bs) &= z_{tk} \label{eq:sitez}\\
  \sigma^2_t(\bs) &= \sigma^2_{tk} \label{eq:sitesig}.
\end{align}
Then within each partition, $Y_t(\bs)$ follows the distribution given in (\ref{eq:fullmodel}).
When incorporating the random daily partition, the $chi$ statistic becomes
\begin{align}
  \chi(\bh) = \lim_{c \rightarrow \infty} \pi(\bh) \chi(\bh)
\end{align}
where $\pi(h)$ is the probability that two sites separated by distance $h$ are in the same partition.
Asymptotic dependence is eliminated as $h$ increases, because
\begin{align}
  \lim_{h \rightarrow \infty} \chi(\bh) = \lim_{h \rightarrow \infty} \pi(\bh) \chi(\bh) = 0.
\end{align}
A proof of this is given in Appendix A.2.


\subsection{Hierarchical model}\label{s:hier}
Conditioned on $z_{tk}(\bs) \iid $ $N(0, \sigma^2_{tk})$, $\sigma^2_{tk}(\bs) \sim IG(a, b)$, and $P_tk$, the marginal distributions are skew-$t$ and the joint distribution within a partition is multivariate skew-$t$. However, we do not fix the partitions, they are treated as unknown and updated in the MCMC.
Thus, standard geostatistical methods can be used to fit the model, and predictions can be made by Kriging at unobserved locations.
We model this with a Bayesian hierarchical model as follows.
Let $w_{t1}, \ldots, w_{tK}$ be a set of daily spatial knots in a spatial domain of interest, $\calD$, so that
\begin{align*}
 P_{tk} = \{\bs : k = \argmin_\ell || \bs_t - w_{t\ell} ||\}.
\end{align*}
Then
\begin{align}
   Y_t(\bs) \mid \Theta, z_{t}(\bs) &= X_t(\bs) \beta + \alpha z_t(\bs) + \sigma
   _t(\bs) v_t(\bs) \label{eq:hier}\\
   z_t(\bs) = z_{tk} \text{ if } \bs \in P_{tk}\\
   \sigma^2_{t}(\bs) = \sigma^2_{tk} \text{ if } \bs \in P_{tk}
   z_{tk} \mid \sigma^2_{tk} &\sim N_{(0, \infty)}(0, \sigma^2_{tk})\\
   \sigma^2_{tk} &\iid IG(\alpha, \beta)\\
   v_t(\bs) \mid \Theta &\sim \Matern(0, \Sigma)\\
   \alpha &\sim N(0, 10)\\
   w_{tk} &\sim Unif(\calD)
\end{align}
where $\Theta = \{w_{t1}, \ldots, w_{tK}, \beta, \sigma_t, \alpha, \lambda, \rho, \nu \}$; \mbox{$k = \argmin_\ell ||\bs - \bw_\ell ||$}; and $\Sigma$ is a \Matern covariance matrix with variance one, spatial range $\rho$, smoothness $\nu$.

\section{Computation}\label{s:comp}
The MCMC for this model is fairly straightforward.
First, we impute values below the threshold.
Then, we update $\Theta$ using random walk MH or Gibbs sampling when appropriate.
Finally, we make spatial precictions using conditional multivariate normal results and the fact that the distribution of $Y_t(\bs) \mid \Theta, z_{tl}$ is the usual multivariate normal distribution with a \Matern spatial covariance structure.

\subsection{Imputation}\label{s:impute}
We can use Gibbs sampling to update $Y_t(\bs)$ for observations that are below $T$, the thresholded value. Given $\Theta$, $Y_t(\bs)$ has truncated normal full conditional with these parameter values.
So we sample $Y_t(\bs) \sim N_{(-\infty, T)}(\mu(\bs), \Sigma)$

\subsection{Parameter updates}\label{s:params}
To update $\Theta$ given the current value of the complete data $\bY_1, \ldots, \bY_T$, we use a standard Gibbs updates for all parameters except for the knot locations which are done using a Metropolis update.
See Appendix A.1 for details regarding Gibbs sampling.

\subsection{Spatial prediction}\label{s:pred}
Given $\bY_t$ the usual Kriging equations give the predictive distribution for $Y_t(\bs^*)$ at prediction location $(\bs^*)$

\section{Simulation study}\label{s:simstudy}
In this section, we conduct a simulation study to investigate how the number of partitions and the level of thresholding impact the accuracy of predictions made by the model.

\subsection{Design}\label{s:simdesign}
For all simulation designs, we generate data from the model presented in Section \ref{s:part} using $n_s=130$ sites and $n_t=50$ independent days.
The sites are generated Uniform$([0, 10] \times [0, 10])$.
We generate data from 6 different simulation designs:
\begin{enumerate} \setlength{\itemsep}{-0.5em}
  \item Gaussian marginal, $K=1$ knot
  \item $t$ marginal, $K=1$ knot
  \item $t$ marginal, $K=5$ knots
  \item skew-$t$ marginal, $K=1$ knots
  \item skew-$t$ marginal, $K=5$ knots
  \item Max-stable.
\end{enumerate}
In the first five designs, the $v_t(\bs)$ terms are generated using a \Matern covariance with smoothness parameter, $\nu = 0.5$, and spatial range, $\rho = 0.1$.
For the covariance matrices in designs 1 -- 5, the proportion of the variance accounted for by the spatial variation is $\gamma = 0.9$ while the proportion of the variance accounted for by the nugget effect is $0.1$.
In the first design, $\sigma^2 = 2$ is used for all days.
For designs 2 -- 4, $sigma^2_{tk} \iid \text{IG}(3, 8)$
For designs 1 -- 3, we set $\alpha = 0$.
For designs four and five, $\alpha = 3$ was used, and the $z_t$ are generated as described in (\ref{eq:sitez}).
In the sixth design, we generate from a spatial max-stable distribution \citep{Reich2012} with parameters $\mu = 1, \sigma=1, \xi=0.2$ and 144 spatial knots on a regular lattice in the square $[1, 9] \times [1, 9]$.
In all six designs, the mean ($\mu(\bs)$) is assumed to be constant across space.

$M = 50$ data sets are generated for each design.
For each data set we fit the data using
\begin{enumerate} \setlength{\itemsep}{-0.5em}
  \item Gaussian marginal, $K=1$ knots
  \item skew-$t$ marginal, $K=1$ knots, $T=-\infty$
  \item skew-$t$ marginal, $K=1$ knots, $T=q(0.90)$
  \item skew-$t$ marginal, $K=5$ knots, $T=-\infty$
  \item skew-$t$ marginal, $K=5$ knots, $T=q(0.9)$
\end{enumerate}
where $q(0.9)$ is the 90th sample quantile of the data.
The design matrix $\bX$ includes on the intercept with a prior of $\beta \sim \text{N}(0, 10)$.
The spatial covariance parameters have priors $\log(\nu) \sim \text{N}(-1.2, 1)$, $\gamma \sim \text{U}(0, 1)$, $\log(\rho) \sim \text{N}(-2, 1)$.
The skewness parameter has prior $\alpha \sim \text{N}(0, 2)$.
The residual variance terms have priors $\sigma^2_t(\bs) \sim \text{IG}(0.1, 0.1)$.

\subsection{Cross validation}\label{s:modelselect}
Models were compared using cross validation with 100 sites used as training sites and 30 sites witheld for testing.
The model was fit using the training set, and predictions were generated at the testing site locations.
Because one of the primary goals of this model is to predict extreme events, we quantify use Brier scores and quantile scores to select the model that best fits the data \citep{Gneiting2007}.
The Brier score for predicting exceedance of a threshold $c$ is given by $[e(c) - P(c)]^2$ where $e(c) = I[y>c]$ is an indicator function indicating that a test set value, $y$, has exceeded the threshold, $c$, and $P(c)$ is the predicted probability of exceeding $c$.
The quantile score for the $\tau$th quantile is $2\{ I[y < \widehat{q}(\tau)] - \tau\} (\widehat{q}(\tau) - y)$ where $y$ is a AQS test set value and $\widehat{q}(\tau)$ is the estimated $\tau$th quantile.
For both the Brier score and the quantile score, a lower score indicates a better fit.
These scores were averaged over all sites and days to obtain a single quantile score for each dataset.

\subsection{Results}\label{s:simresults}

\section{Data analysis}\label{s:analysis}
To illustrate this method, we consider the daily maximum 8-hour ozone measurements for July 2005 at 735 Air Quality System (AQS) monitoring sites in the eastern United States as the response.
For each site, we also have covariate information containing the estimated ozone from the Community Multi-scale Air Quality (CMAQ) modeling system.
We fit the model using Gaussian and skew-$t$ marginal distributions, $K=1, 5, 10, 15$ partitions, with $Y(\bs)$ censored at $T = 0, 50, 75, 90$ ppb as described in Section \ref{s:data}.
We also include a max-stable analysis using the method by ????
All methods assume the location can be expressed as
\begin{align}
  \mu_t(\bs) = \beta_0 + \beta_1 \cdot \text{CMAQ}_t(\bs).
\end{align}
To explore the extremal dependence both over space and time, we plot $\chi(\bs)$ and $\chi(t)$.
For each model, Brier scores and quantile scores were were averaged over all sites and days to obtain a single quantile score for each dataset.
At a particular threshold or quantile level, the model that fits the best is the one with the lowest score.

\subsection{Results}\label{s:results}

\section{Conclusions}\label{s:con}

\section*{Acknowledgments}

\section*{Appendix A.1: Posterior distributions}
\input{zpost.tex}
\input{betapost.tex}
\input{sigpost.tex}
\input{alphapost.tex}

\section*{Appendix A.2: Proof that $\lim_{h \rightarrow \infty} \pi(h) = 0$}
\input{proof_dist.tex}

\section*{Appendix A.3: Half-normal distribution}
Let $u = |z|$ where $Z \sim N(\mu, \sigma^2)$.
Specifically, we consider the case where $\mu = 0$. Then $U$ follows a half-normal distribution which we denote as $U \sim HN(0, 1)$, and the density is given by
\begin{align}
  f_U(u) = \frac{ \sqrt{2} }{ \sqrt{\pi \sigma^2} } \exp \left( - \frac{ u^2 }{ 2 \sigma^2 } \right) I(u > 0)
\end{align}
When $\mu = 0$, the half-normal distribution is also equivalent to a $N_{(0, \infty)}(0, \sigma^2)$ where $N_{(a, b)}(\mu, \sigma^2)$ represents a normal distribution with mean $\mu$ and standard deviation $\sigma$ that has been truncated below at $a$ and above at $b$.

\bibliographystyle{rss}
\bibliography{skewnormal}

\end{document}


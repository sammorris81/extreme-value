\documentclass[11pt]{article}
\usepackage{amssymb, amsthm, amsmath}
\usepackage{bm}
\usepackage{graphicx}
\usepackage[authoryear]{natbib}
\usepackage{bm}
\usepackage{verbatim}
\usepackage{lineno}
\usepackage{times}
\usepackage{soul}
\usepackage{color}

\usepackage[left=1in,top=1in,right=1in]{geometry}
\pdfpageheight 11in
\pdfpagewidth 8.5in
\linespread{1.0}
\input{mycommands.sty}


\begin{document}\linenumbers

\begin{center}
{\Large {\bf A new spatial model for points above a threshold}}\\
\today
\end{center}

\section{Introduction}\label{s:intro}
In most climatological applications, researchers are interested in learning about the average behavior of different climate variables (e.g. ozone, temperature, rainfall).
However, averages do not help regulators prepare for the unusual events that only happen once every 100 years.
For example, it is important to have an idea of how much rain will come in a 100-year floor in order to construct strong enough river levees to protect lands from flooding.

Unlike multivariate normal distributions, it is challenging to model multivariate extreme value distributions (e.g. generalized extreme value and generalized Pareto distribution) because few closed-form expressions exist for the density in more than two-dimensions \citep{Coles1991}.
Given this limitation, pairwise composite likelihoods have been used when modeling dependent extremes \citep{Padoan2010,Blanchet2011,Huser2013}.

One way around the multi-dimensional limitation of multivariate extreme value distributions is to use skew elliptical distributions to model dependent extreme values \citep{Genton2004,Zhang2010,Padoan2011}.
Due to their flexibility, the skew-normal and skew-$t$ distribution offer a flexible way to handle non-symmetric data within a framework of multivariate normal and multivariate t-distributions.
As with the spatial Gaussian process, the skew-normal distribution is also asymptotically independent; however, the skew-$t$ does demonstrate asymptotic dependence \citep{Padoan2011}.
Although asymptotic dependence is desirable between sites that are near one another, one drawback to the skew-$t$ is that sites remain asymptotically dependent even at far distances.

In this paper, we present a model that has marginal distributions with flexible tails, demonstrates asymptotic dependence for observations at sites that are near to one another, and has computation on the order of Gaussian models for large space-time datasets.
Specifically, our contribution is to incorporate thresholding and random spatial partitions using a multivariate skew-$t$ distribution.
The advantage of using a thresholded model as opposed to a non-thresholded model is that is allows for the tails of the distribution to inform the predictions in the tails \citep{DuMouchel1983}.
The random spatial partition alleviates the long-range spatial dependence seen by the skew-$t$.

The paper is organized as follows.
In section \ref{s:spatial}, we describe a spatial skew-$t$ process with partitioning and thresholding.
In section \ref{s:temporal}, we expand the model to incorporate temporal dependence.
The computing is described in section \ref{s:comp}.
In section \ref{s:simstudy}, we present a simulation study that examines the predictive capabilities of this model compared with a na{\"i}ve Gaussian method.
We then compare our method to Gaussian and max-stable methods with a data analysis of ozone measurements from the eastern US in section \ref{s:analysis}.
The final section provides brief discussion and direction for future research.

\section{Spatial model}\label{s:spatial}
To avoid bias in estimating tail parameters, we model censored data.
Let
\beq\label{Yt}
  \tilde{Y}(\bs) = \delta(\bs) Y(\bs) + (1 - \delta(\bs)) T
\eeq
be the censored observation at site $\bs$ where $Y(\bs)$ is the uncensored observation, $\delta(\bs) = I[Y(\bs) > T]$, and $T$ is a pre-specified threshold value.
Then, assuming the uncensored data are observations from a skew-$t$ process, we update values censored below the threshold using standard Bayesian missing data methods as described in Section \ref{s:comp}.

\subsection{Skew-$t$ process}\label{s:data}
Many types of data demonstrate some level of skewness, and therefore should be modeled with distributions that allow for non-symmetry.
The skew-elliptical family of distributions provides models that are mathematically tractable while introducing additional paremeters to account for non-symmetric data \citep{Genton2004}.
One member of this family, is the skew-$t$ distribution \citep[see Appendix A.5]{Azzalini2003}.
\citet{Zhang2010} show that the skew-$t$ can be expressed as a hierarchical model
\begin{align} \label{eq:fullmodel}
  \bY &= \bX \bbeta + \alpha |z| + \sigma \bv
\end{align}
where $\alpha \in \calR$ controls the skewness; $z \sim N(0, \sigma^2)$ is a random effect from a half-normal distribution (see appendix A.4); $\bv$ is a Gaussian process with mean zero, variance one, \Matern spatial correlation with spatial range $\rho$, smoothness $\nu$, and $\gamma$ is the proportion of variance accounted for by the spatial variation; and $\sigma^2 \sim \text{IG}(a, b)$.
When marginalizing over the $z$ and $\sigma^2$ terms, the joint distribution for all sites becomes
\begin{align*}
  \bY \sim \text{skew-}t (\mu, \bSigma^*, \alpha, \text{df} = 2a)
\end{align*}
where $\mu$ is the location, $\bSigma^* = \frac{ b }{ a } \bSigma$, $\bSigma$ is a \Matern covariance matrix, and $\alpha \in \calR$ controls the skewness.
The skew-$t$ process is desirable because of its flexible tail that is controlled by the skewness parameter, $\alpha$, and the degrees of freedom, $2a$.
Furthermore, if $\bY$ follows a multivariate skew-$t$ distribution, the marginal distributions also follow a skew-$t$ distribution \citep{Azzalini2003}.

\subsection{Extremal dependence}
One measure of extremal dependence is the $\chi$ statistic \citep{Padoan2011}.
The $\chi$ statistic for the upper tail is given by
\begin{align*}
  \chi = \lim_{c \rightarrow \infty} \Pr(Y(\bs_1) > c | Y(\bs_2) > c).
\end{align*}
In a stationary spatial process, we can write the $\chi$ coefficient as
\begin{align*}
  \chi(h) = \lim_{c \rightarrow \infty} \Pr(Y(0) > c | Y(h) > c)
\end{align*}
where $h = ||\bs_1 - \bs_2||$.
If $\chi(h) = 0$, then observations are asymptotically independent at distance $h$.
For Gaussian processes, $\chi(h) = 0$ regardless of the the distance, so they are not suitable for modeling spatially dependent extremes.
However, for the skew-$t$ process described in \ref{s:data}, $\chi(h) > 0$ \citep[they give an expression that is the sum of two survival functions from the skew-$t$ distribution. The expression isn't terribly informative, but I can include it if you think it would be helpful.]{Padoan2011}.

\subsection{Random daily partition}\label{s:part}
One problem with the spatial skew-$t$ process is that all sites are asymptotically dependent regardless of their spatial separation.
This occurs because all observations, both near and far, share the same $z$ and $\sigma^2$ terms.
Even more problematic is that $\lim_{h \rightarrow \infty} \chi(h) \neq 0$.
We handle this problem with a random partition similar to \citet{Kim2005} that allows $z$ and $\sigma^2$ to vary by site.

Consider a set of spatial knots $\bw_{k} \sim \text{Uniform}(\calD)$ that define a random daily partition $P_{1}, \ldots, P_{K}$ of the spatial domain of interest $\calD \subset \calR^2$ such that
\begin{align*}
  P_{k} = \{ \bs : k = \argmin_\ell || \bs - \bw_{\ell} || \}.
\end{align*}
Then, the observation at each site becomes
\begin{align}
  Y(\bs) &= X(\bs) \bbeta + \alpha |z(\bs)| + \sigma v(\bs),
\end{align}
and, for $\bs \in P_{k}$,
\begin{align}
  z(\bs) &= z_{tk} \label{eq:sitez}\\
  \sigma(\bs) &= \sigma_{k} \label{eq:sitesig}.
\end{align}
So, within each partition, $\bY$ follows the distribution given in (\ref{eq:fullmodel}).

When incorporating the random daily partition, for two sites in the same partition, the $\chi$ statistic is $\chi(h) = \chi_{\text{skew-}t}(h)$. However, for two sites in different partitions, the $\chi$ statistic should be the same as the Gaussian $\chi(h)$, because the only correlation between the two sites, is the correlation given by $\bSigma$.
So, to show that $\lim_{h \rightarrow \infty} \chi(h) = 0$, we need only know that $\lim_{h \rightarrow \infty} \pi(h) = 0$
where $\pi(h)$ is the probability that two sites separated by distance $h$ are in the same partition.
A proof of this is given in Appendix A.3.

Figure \ref{fig:simchi} shows $\chi(h)$ for different sample quantiles from simulated datasets where $\bs \in [0, 1] \times [0, 1]$.
These plots show how the partitioning allows for short range extremal dependence while reducing extremal dependence as the distance between sites increases.
\begin{figure}
  \includegraphics[width=\linewidth]{plots/sim-chi.pdf}
  \caption{$\chi(h)$ for simulated datasets.}
  \label{fig:simchi}
\end{figure}

\section{Accounting for temporal dependence} \label{s:temporal}
In a standard block-maxima approach, the temporal dependence is assumed to be negligible because blocks (e.g. yearly maxima) are taken to be large enough to assume independence.
However, when using daily meausrements, the assumption of temporal independence is no longer appropriate.
There are several places where temporal dependence could be included, including the residual $v(\bs)$.
However, we choose to allow for temporal dependence in the $\bw$, $z(\bs)$, and $\sigma(\bs)$ terms because these terms derive the tail behavior.
Specifically, we incorporate an AR(1) time series.
We first, transform the spatial knots from $\calD$ to $\calR^2$ as follows.
Let
\begin{align*}
  \bw^*_k = \Phi^{-1}_2\left[ \frac{ (\bw_k - \min(\bs))}{ \text{range}(\bs) } \right].
\end{align*}
\hl{What's the best way to write the $\bw$ transformation as 1-D? $w_x$ and $w_y$ or $w_1$ and $w_2$?}
where $\Phi_2$ represents a bivariate standard normal density function.
Then $\bw^*_k \in \calR^2$.
We use a copula on the $\sigma^2_t(\bs)$ to ensure that the marginal distributions of $\sigma^2_t(\bs)$ are inverse gamma.
Let
\begin{align*}
  \sigma^{2*}_t(\bs) =\Phi^{-1}\left\{ \text{IG}[\sigma^2_t(\bs)] \right\}
\end{align*}
where $\Phi$ is a univariate standard normal density function, and IG is the distribution function for an IG$(a, b)$ random variable.
Then, when $t > 1$ the time series is modeled as
\begin{align*}
  \bw^*_{1, k} & \sim N_2(0, 1)\\
  z_{1k} & \sim N(0, \sigma^2_{1k})\\
  \sigma^{2*}_{1k} &\sim N(0, 1)\\
  \bw^*_{tk} | \bw^*_{t-1, k} &\sim N_2\left[\phi_w \bw^*_{t-1, k}, (1 - \phi_w^2) \right] \\
  z_{tk} | z_{t-1, k} &\sim N \left[\phi_z z_{t-1, k}, \sigma^2_{tk} (1 - \phi_z^2)\right] \\
  \sigma^{2*}_{tk} | \sigma^{2*}_{t-1, k} &\sim N \left[\phi_\sigma \sigma^{2*}_{t-1, k}, (1 - \phi_\sigma^2) \right]
\end{align*}
where $|\phi_w| < 1$, $0 < \phi_z < 1$, and $|\phi_\sigma| < 1$.
These are stationary time series models with marginal distributions
\begin{align*}
  \bw^*_{k} & \sim N_2(0, 1)\\
  z_{k} & \sim N(0, \sigma^2_{k})\\
  \sigma^{2*}_{k} &\sim N(0, 1).
\end{align*}
For each day, the model is identical to the spatial-only model in Seciton \ref{s:part}.

\subsection{Hierarchical model}\label{s:hier}
Conditioned on $z_{tk}(\bs)$, $\sigma^2_{t,k}(\bs)$, and $P_{t,k}$, the marginal distributions are Gaussian and the joint distribution multivariate Gaussian.
However, we do not fix the partitions, they are treated as unknown and updated in the MCMC.
We model this with a Bayesian hierarchical model as follows.
Let $\bw_{t,1}, \ldots, \bw_{t,K}$ be a set of daily spatial knots in a spatial domain of interest, $\calD$, and $P_{tk}$ as defined in \ref{s:part}.

Then
\begin{align}
   Y_t(\bs) \mid z_{t}(\bs), \sigma^2(\bs), P_{tk}, \alpha, \beta, \Theta &= X_t(\bs) \beta + \alpha |z_t(\bs)| + \sigma_t(\bs) v_t(\bs) \label{eq:hier}\\
   z_t(\bs) &= z_{tk} \text{ if } \bs \in P_{tk}\\
   \sigma^2_{t}(\bs) &= \sigma^2_{tk} \text{ if } \bs \in P_{tk}\\
   \alpha &\sim N(0, 10)\\
   v_t(\bs) \mid \Theta &\sim \Matern(0, \Sigma)\\
   z_{tk} \mid z_{t-1, k}, \sigma^2_{tk} &\sim N(\phi_z z_{t-1, k}, \sigma^2_{tk} (1 - \phi_z^2))\\
   \sigma^{2*}_{tk} \mid \sigma^{2*}_{t-1, k} &\sim N(\phi_\sigma \sigma^{2*}_{t-1, k}, (1 - \phi_\sigma^2))\\
   \bw^*_{tk} \mid \bw^*_{t-1, k} &\sim N_2(\phi_w \bw^*_{t-1, k}, (1 - \phi_w^2))
\end{align}
where $\Theta = \{\rho, \nu, \gamma\}$; \mbox{$k = \argmin_\ell ||\bs - \bw_\ell ||$}; and $\Sigma$ is a \Matern covariance matrix with variance one, spatial range $\rho$, smoothness $\nu$, and the proportion of variance accounted for by the spatial variation is $\gamma$.

\section{Computation}\label{s:comp}
First, we impute values below the threshold.
Then, we update $\Theta$ using Metropolis Hastings or Gibbs sampling when appropriate.
Finally, we make spatial predictions using conditional multivariate normal results and the fact that the distribution of $Y_t(\bs) \mid \Theta, z(\bs)$ is the usual multivariate normal distribution with a \Matern spatial covariance structure.

We can use Gibbs sampling to update $Y_t(\bs)$ for censored observations that are below the threshold $T$.
After conditioning on $\alpha$, $z_t(\bs)$ and non-censored observations, $Y_t(\bs)$ has truncated normal full conditionals.
So we sample $Y_t(\bs) \sim N_{(-\infty, T)}(\mu(\bs), \bSigma)$.
After imputing the censored observations, we update the model parameters.
To update the model parameters, we use standard Gibbs updates for parameters when possible.
In the case Gibbs sampling is not possible, parameters are updated using a random-walk Metropolis Hastings algorithm.
See Appendices A.1 and A.2 for details regarding the MCMC.
The final step of the computation is to use Bayesian Kriging to generate a predictive distribution for $Y_t(\bs^*)$ at prediction location $\bs^*$.
This step is similar to the imputation for censored observations except that the full conditionals are no longer truncated at $T$.

\section{Simulation study}\label{s:simstudy}
In this section, we conduct a simulation study to investigate how the number of partitions and the level of thresholding impact the accuracy of predictions made by the model.

\subsection{Design}\label{s:simdesign}
For all simulation designs, we generate data from the model in Section \ref{s:part} using $n_s=144$ sites and $n_t=50$ independent days.
The sites are generated Uniform$([0, 10] \times [0, 10])$.
We generate data from 6 different simulation designs:
\begin{enumerate} \setlength{\itemsep}{-0.5em}
  \item Gaussian marginal, $K=1$ knot
  \item $T$ marginal, $K=1$ knot
  \item $T$ marginal, $K=5$ knots
  \item Skew-$t$ marginal, $K=1$ knots
  \item Skew-$t$ marginal, $K=5$ knots
  \item Max-stable.
\end{enumerate}
In the first five designs, the $v_t(\bs)$ terms are generated using a \Matern covariance with smoothness parameter $\nu = 0.5$ and spatial range $\rho = 0.1$.
For the covariance matrices in designs 1 -- 5, the proportion of the variance accounted for by the spatial variation is $\gamma = 0.9$ while the proportion of the variance accounted for by the nugget effect is $0.1$.
In the first design, $\sigma^2 = 2$ is used for all days.
For designs 2 -- 4, $\sigma^2_{tk} \iid \text{IG}(3, 8)$
For designs 1 -- 3, we set $\alpha = 0$.
For designs four and five, $\alpha = 3$ was used, and the $z_t$ are generated as described in (\ref{eq:sitez}).
In the sixth design, we generate from a spatial max-stable distribution \citep{Reich2012} with parameters $\mu = 1, \sigma=1, \xi=0.2$ and 144 spatial knots on a regular lattice in the square $[1, 9] \times [1, 9]$.
\hl{I know I need more here about the max-stable method}
In all six designs, the mean $\mu(\bs) = 10$ is assumed to be constant across space.

$M = 50$ data sets are generated for each design.
For each data set we fit the data using
\begin{enumerate} \setlength{\itemsep}{-0.5em}
  \item Gaussian marginal, $K=1$ knots
  \item Skew-$t$ marginal, $K=1$ knots, $T=-\infty$
  \item $T$ marginal, $K=1$ knots, $T=q(0.80)$
  \item Skew-$t$ marginal, $K=5$ knots, $T=-\infty$
  \item $T$ marginal, $K=5$ knots, $T=q(0.80)$
\end{enumerate}
where $q(0.80)$ is the 80th sample quantile of the data.
The design matrix $\bX$ includes an the intercept with a prior of $\beta \sim \text{N}(0, 10)$.
The spatial covariance parameters have priors $\log(\nu) \sim \text{N}(-1.2, 1)$, $\gamma \sim \text{U}(0, 1)$, $\log(\rho) \sim \text{N}(-2, 1)$.
The skewness parameter has prior $\alpha \sim \text{N}(0, 2)$.
The residual variance terms have priors $\sigma^2_t(\bs) \sim \text{IG}(0.1, 0.1)$.
The knots have priors $\bw \sim \text{Unif}(\calD)$.
We do not fit the data using the max-stable methods from \citet{Reich2012} because of the time it takes.

\subsection{Cross validation}\label{s:modelselect}
Models were compared using cross validation with 100 sites used as training sites and 30 sites witheld for testing.
The model was fit using the training set, and predictions were generated at the testing site locations.
Because one of the primary goals of this model is to predict extreme events, we use Brier scores to select the model that best fits the data \citep{Gneiting2007}.
The Brier score for predicting exceedance of a threshold $c$ is given by $[e(c) - P(c)]^2$ where $e(c) = I[y>c]$ is an indicator function indicating that a test set value, $y$, has exceeded the threshold, $c$, and $P(c)$ is the predicted probability of exceeding $c$.
We average the Brier scores over all test sites and days.
For the Brier score, a lower score indicates a better fit.

\subsection{Results}\label{s:simresults}
We compared the Brier scores for exceeding 11 different thresholds for each dataset.
The thresholds used for the Brier scores are extreme quantiles from the simulated data.
Figure \ref{fig:simbrierscores} gives the Brier score relative to the Brier score for the Gaussian method calculated as
\begin{align*}
  \text{BS}_{\text{rel}} = \frac{\text{BS}_{\text{method}}}{\text{BS}_{\text{Gaussian}}}.
\end{align*}
For data that are relatively symmetric, the standard Gaussian method outperforms the other methods.
However, when the data come from a skewed distribution (settings 3 -- 6), the partitioned and thresholded methods outperform the Gaussian method.
Additionally, for both of the skew-$t$ settings ($K = 1$, $K = 5$), the skew-$t$ method with the appropriate number of partitions performs the best.
Finally, the simulation results suggest that for data from a skew-$t$ distribution, thresholded methods provide some improvement over non-thresholded models for the extreme thresholds.
With the exception of the Brier score for $c = q(0.995)$ in setting 6, the improvement over the Gaussian method is statistically significant using a Wilcoxon signed rank test ($\alpha = 0.05$).


\begin{figure}
  \includegraphics[width=\linewidth]{plots/bsplots-mean.pdf}
  \caption{Brier scores relative to the Gaussian method for simulation study results. A ratio lower than 1 indicates that the method outperforms relative to the Gaussian method.}
  \label{fig:simbrierscores}
\end{figure}

\section{Data analysis}\label{s:analysis}
To illustrate this method, we consider the daily maximum 8-hour ozone measurements for July 2005 at 735 Air Quality System (AQS) monitoring sites in the eastern United States as the response (see Figure \ref{fig:ozone}).
For each site, we also have covariate information containing the estimated ozone from the Community Multi-scale Air Quality (CMAQ) modeling system.
Initially, we fit a linear regression assuming a mean function of
\begin{align}
  \mu_t(\bs) = \beta_0 + \beta_1 \cdot \text{CMAQ}_t(\bs). \label{eq:datamean}
\end{align}
The data from July 10 are shown in Figure \ref{fig:ozone} along with a Q-Q plot of the residuals compared to a skew-$t$ distribution with 8 d.f. and $\alpha = 1$.
\begin{center}
\begin{figure}
  \includegraphics[width=0.5\linewidth]{plots/ozone-10jul.pdf}
  \includegraphics[width=0.5\linewidth]{plots/qq-res.pdf}
  \caption{Ozone values on 10 July 2005 (left) Q-Q plot of the residuals (right)}
  \label{fig:ozone}
\end{figure}
\end{center}
The $\widehat{\chi}(h)$ and $\widehat{\chi}(t)$ plots estimate the spatial and temporal dependence using sample data.
For $\widehat{\chi}(h)$, we take the sample proportion of all pairs of sites within distance $h$ of one another that are above a threshold $T$.
\hl{I know I need another sentence or two here about $\widehat{\chi}(t)$}
indicate that the residuals still demonstrate spatial and temporal dependence (see Figure \ref{fig:chi-st})
\begin{center}
\begin{figure}
  \includegraphics[width=0.5\linewidth]{plots/chi-h-ozone.pdf}
  \includegraphics[width=0.5\linewidth]{plots/chi-t-ozone.pdf}
  \caption{$\widehat{\chi}(h)$ plot for the residuals. The vertical line indicates the distance after which observations no longer demonstrate dependence (left) $\widehat{\chi}(t)$ plot for the residuals (right)}
  \label{fig:chi-st}
\end{figure}
\end{center}

\subsection{Model comparisons}
We fit the model using Gaussian and skew-$t$ marginal distributions, $K=1, 5, 10, 15$ partitions, with $Y(\bs)$ censored at $T = 0, 50, 75, 90$ ppb as described in Section \ref{s:data}.
We also include a max-stable analysis using the method by ????
All methods assume the mean function given in (\ref{eq:datamean}).
For each model, Brier scores and quantile scores were were averaged over all sites and days to obtain a single quantile score for each dataset.
At a particular threshold or quantile level, the model that fits the best is the one with the lowest score.
Looking at the heatplot in Figure \ref{fig:heatplot}, we can see that the methods using no thresholding tend to outperform those methods that do use thresholding.


\subsection{Results}\label{s:results}
\begin{figure}
  \includegraphics[width=0.5\linewidth]{plots/heatplot.pdf}
  \includegraphics[width=0.5\linewidth]{plots/qscore-best.pdf}
  \caption{Heatplot of quantile scores for the 99th quantile (left) Quantile scores of Gaussian, skew-$t$ (K=10, T=q(0)), and Max-stable (right)}
  \label{fig:heatplot}
\end{figure}

\section{Conclusions}\label{s:con}

\section*{Acknowledgments}

\section*{Appendix A.1: MCMC details}
The MCMC sampling for the model \ref{s:hier} is done using {\tt R} (http://www.r-project.org). Whenever possible, we select conjugate priors (see Appendix A.2); however, for some of the parameters, no conjugate prior distributions exist.
When no conjugate prior distribution exists, we use a random walk Metropolis Hastings update step.
In each Metropolis Hastings update, we tune the algorithm to give acceptance rates near 0.40.

\subsection*{Spatial knot locations}
For each day, we update the spatial knot locations, $\bw_1, \ldots, \bw_K$, using a Metropolis Hastings block update.
Because the spatial domain is bounded, we generate candidate knots using the transformed knots $\bw^*_1, \ldots, \bw^*_K$ (see section \ref{s:temporal}) and a random walk bivariate Gaussian candidate distribution
\begin{align*}
	{\bw^*_k}^{(c)} \sim \text{N}({\bw^*_k}^{(r - 1)}, s^2 I_2)
\end{align*}
where ${\bw^*_k}^{(r - 1)}$ is the location for the transformed knot at MCMC iteration $r - 1$, $s$ is a tuning parameter, and $I_2$ is an identity matrix.
After candidates have been generated for all $K$ knots, the acceptance ratio is
\begin{align*}
  R = \left\{ \frac{ l[ Y_t(\bs | \bw_1^{(c)}, \ldots, \bw_K^{(c)}, \ldots)] }{l[ Y_t(\bs | \bw_1^{(r - 1)}, \ldots, \bw_K^{(r - 1)}, \ldots)]} \right\} \times \left\{ \frac{ \prod_{k = 1}^{K}\phi(\bw_k^{(c)})}{ \prod_{k = 1}^{K}\phi(\bw_k^{(r - 1)})} \right\} \times \left\{ \frac{ \prod_{k = 1}^{K} p({\bw^*_k}^{(c)})}{ \prod_{k = 1}^{K} p({\bw^*_k}^{(r - 1)})}\right\}
\end{align*}
where $l$ is the likelihood given in (\ref{eq:hier}), and $p(\cdot)$ is the prior either taken from the time series given in (\ref{s:temporal}) or assumed to be uniform over $\calD$.
The candidate knots are accepted with probability $\min\{R, 1\}$.

\subsection*{Spatial random effects}
If there is temporal dependence amongst the observations, then we update $z_{tk}$ using a Metropolis Hastings update.
First, we generate a candidate using a random walk Gaussian candidate distribution
\begin{align*}
  z_{tk}^{(c)} \sim \text{N}(z_{tk}^{(r - 1)}, s^2)
\end{align*}
where $z_{tk}^{(r-1)}$ is the value at MCMC iteration $r - 1$, and $s$ is a tuning parameter.
The acceptance ratio is
\begin{align*}
  R = \left\{ \frac{ l[Y_t(\bs) | z_{tk}^{(c)}, \ldots] }{ l[Y_t(\bs) | z_{tk}^{(r - 1)}]} \right\} \times \left\{ \frac{ p[ z_{tk}^{(c)} ] }{ p[ z_{tk}^{(r - 1)}]}\right\}.
\end{align*}
The candidate is accepted with probability $\min\{R, 1\}$.

\subsection*{Variance terms}
When there is more than one site in a partition, then we update $\sigma^2_{tk}$ using a Metropolis Hastings update.
First, we generate from one of two candidate distributions.
In the case of temporal dependence, we generate a candidate for ${\sigma^*_{tk}}^2$ using a random walk Gaussian candidate distribution
\begin{align*}
  {\sigma^{*2}_{tk}}^{(c)} \sim \text{N}({\sigma^{*2}_{tk}}^{(r - 1)}, s^2)
\end{align*}
where ${{\sigma^*_{tk}}^2}^{(r - 1)}$ is the value at MCMC iteration $r - 1$, and $s$ is a tuning parameter.
In the case where there is no temporal dependence, we generate a candidate for $\sigma^2_{tk}$ using an IG$(a^*/s, b^*/s)$ candidate distribution in an independence Metropolis Hastings update where $a^* = (n_{tk} + 1) / 2 + a$, $b^* = [Y_{tk}^T \Sigma^{-1}_{tk} Y_{tk} + z_{tk}^2] / 2 + b$, $n_{tk}$ is the number of sites in partition $k$ on day $t$, and $Y_{tk}$ and $\Sigma^{-1}_{tk}$ are the observations and precision matrix for partition $k$ on day $t$.
The acceptance ratio is
\begin{align*}
  R = \left\{
    \frac{ l[Y_t(\bs) | {\sigma^2_{tk}}^{(c)}, \ldots] }
         { l[Y_t(\bs) | {\sigma^2_{tk}}^{(r - 1)}]}
    \right\} \times \left\{
    \frac{ l[z_tk | {\sigma^2_{tk}}^{(c)}, \ldots] }
         { l[z_tk | {\sigma^2_{tk}}^{(r - 1)}, \ldots] }
    \right\} \times \left\{
    \frac{ p[ {\sigma^2_{tk}}^{(c)} ] }
         { p[ {\sigma^2_{tk}}^{(r - 1)}] }
    \right\} \times \left\{
    \frac{ c[ {\sigma^2_{tk}}^{(r - 1)}] }
         { c[ {\sigma^2_{tk}}^{(c)}]}
    \right\}
\end{align*}
where $p[\cdot]$ is the prior either taken from the time series given in (\ref{s:temporal}) or assumed to be IG$(a, b)$, and $c[\cdot]$ is the candidate distribution.
The candidate is accepted with probability $\min\{R, 1\}$.

\subsection*{Spatial covariance parameters}
We update the three spatial covariance parameters, $\log(\rho)$, $\log(\nu)$, $\gamma$, using a Metropolis Hastings block update step.
First, we generate a candidate using a random walk Gaussian candidate distribution
\begin{align*}
	\log(\rho)^{(c)} \sim \text{N}(\log(\rho)^{(r - 1)}, s^2)
\end{align*}
where $\log(\rho)^{(r-1)}$ is the value at MCMC iteration $r - 1$, and $s$ is a tuning parameter.
Candidates are generated for $\log(\nu)$ and $\gamma$ in a similar fashion.
The acceptance ratio is
\begin{align*}
	R = \left\{ \frac{ \prod_{t = 1}^{T} l[Y_t(\bs) | \rho^{(c)}, \nu^{(c)}, \gamma^{(c)}, \ldots] }{\prod_{t = 1}^{T} l[Y_t(\bs) | \rho^{(r-1)}, \nu^{(r-1)}, \gamma^{(r-1)}, \ldots] } \right\} \times \left\{ \frac{ p[\rho^{(c)}] }{ p[\rho^{(r - 1)] } } \right\} \times \left\{ \frac{ p[\nu^{(c)}] }{ p[\nu^{(r - 1)}] } \right\} \times \left\{ \frac{ p[ \gamma^{(c)} ] }{ p[\gamma^{(r - 1)} ] } \right\}.
\end{align*}
All three candidates are accepted with probability $\min\{R, 1\}$.

\section*{Appendix A.2: Posterior distributions}
\input{zpost.tex}
\input{betapost.tex}
\input{sigpost.tex}
\input{alphapost.tex}

\section*{Appendix A.3: Proof that $\lim_{h \rightarrow \infty} \pi(h) = 0$}
Let $N(A)$ be the number of knots in $A$, the area between sites $\bs_1$ and $\bs_2$.
Consider a spatial Poisson process with intensity $\mu(A)$.
So,
\begin{align*}
  P[ N(A) = k] = \frac{ \mu(A)^k \exp\{ -\mu(A)\}}{k!}.
\end{align*}
Then for any finite $k$, $\lim_{h \rightarrow \infty} P[N(A) = k] = 0$ because $\lim_{h \rightarrow \infty} \mu(A) = \infty$.
With each additional knot in $A$, the chance that $\bs_1$ and $\bs_2$ will be be in the same partition will decrease, because partition membership is defined by the closest knot to a site.
Therefore, $\lim_{h \rightarrow \infty} \pi(h) = 0$.

\section*{Appendix A.4: Half-normal distribution}
Let $u = |z|$ where $Z \sim N(\mu, \sigma^2)$.
Specifically, we consider the case where $\mu = 0$. Then $U$ follows a half-normal distribution which we denote as $U \sim HN(0, 1)$, and the density is given by
\begin{align}
  f_U(u) = \frac{ \sqrt{2} }{ \sqrt{\pi \sigma^2} } \exp \left( - \frac{ u^2 }{ 2 \sigma^2 } \right) I(u > 0)
\end{align}
When $\mu = 0$, the half-normal distribution is also equivalent to a $N_{(0, \infty)}(0, \sigma^2)$ where $N_{(a, b)}(\mu, \sigma^2)$ represents a normal distribution with mean $\mu$ and standard deviation $\sigma$ that has been truncated below at $a$ and above at $b$.

\section*{Appendix A.5: Multivariate skew-$t$ distribution}
\input{mvskewt.tex}

\bibliographystyle{rss}
\bibliography{skewnormal}

\end{document}

